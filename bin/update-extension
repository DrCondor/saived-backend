#!/bin/bash
set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

BACKEND_DIR="$(cd "$(dirname "$0")/.." && pwd)"
EXTENSION_DIR="$BACKEND_DIR/../saived-extension"
VERSION_FILE="$BACKEND_DIR/config/initializers/extension_version.rb"
ZIP_PATH="$BACKEND_DIR/public/downloads/saived-extension.zip"

echo -e "${YELLOW}üîÑ Aktualizacja wtyczki SAIVED${NC}"
echo ""

# 1. Check if extension directory exists
if [ ! -d "$EXTENSION_DIR" ]; then
  echo "‚ùå Nie znaleziono katalogu extension: $EXTENSION_DIR"
  exit 1
fi

# 2. Create ZIP with all extension files
echo -e "${GREEN}üì¶ Tworzenie ZIP...${NC}"
rm -f "$ZIP_PATH"

# Create zip from extension directory (preserves folder structure for lib/)
cd "$EXTENSION_DIR"
zip -r "$ZIP_PATH" \
  manifest.json \
  popup.html \
  popup.js \
  content-script.js \
  logo.jpg \
  icon48.png \
  icon96.png \
  icon128.png \
  lib/

cd "$BACKEND_DIR"
echo "   Utworzono: $ZIP_PATH"
echo ""

# 3. Bump version
echo -e "${GREEN}‚¨ÜÔ∏è  Bumpowanie wersji...${NC}"
CURRENT_VERSION=$(grep -o 'EXTENSION_VERSION = [0-9]*' "$VERSION_FILE" | grep -o '[0-9]*')
NEW_VERSION=$((CURRENT_VERSION + 1))
sed -i '' "s/EXTENSION_VERSION = $CURRENT_VERSION/EXTENSION_VERSION = $NEW_VERSION/" "$VERSION_FILE"
echo "   $CURRENT_VERSION ‚Üí $NEW_VERSION"
echo ""

echo -e "${GREEN}‚úÖ Gotowe! Wtyczka zaktualizowana do v$NEW_VERSION${NC}"
echo ""
echo "Nastƒôpne kroki:"
echo "  git add public/downloads/saived-extension.zip config/initializers/extension_version.rb"
echo "  git commit -m 'chore: update extension to v$NEW_VERSION'"
echo "  git push && fly deploy"
